<!DOCTYPE html>
<html>
<head>
  <title>Live Order Tracking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
    }
    #map {
      height: 100%;
      width: 100%;
      display: none; 
    }
    #expiredNotice {
      position: absolute;
      top: 20px;
      left: 20px;
      background: red;
      color: white;
      padding: 10px;
      z-index: 99;
      display: none;
      font-weight: bold;
    }
    #errorMsg {
      color: red;
      position: absolute;
      top: 20px;
      right: 20px;
      background: white;
      padding: 6px 10px;
      border: 1px solid red;
      z-index: 99;
      display: none;
    }
  </style>
</head>
<body>

  <div id="expiredNotice">This tracking link has expired.</div>
  <div id="errorMsg"></div>
  <div id="map"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <!-- Google Maps JS API -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA40-Fss_E_pbEKyCvMJqL_DDJxkAOrdec"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBmZAMmxmHL6riRAOqDJC-f5P0fVtjhmqE",
      authDomain: "fuel-app-756ae.firebaseapp.com",
      projectId: "fuel-app-756ae",
      storageBucket: "fuel-app-756ae.appspot.com",
      messagingSenderId: "1075562726618",
      appId: "1:1075562726618:web:d2443d0589b697925251e3"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let map, driverMarker, dropoffMarker, routePolyline;
    let driverInfoWindow, dropoffInfoWindow;
    let unsubscribe = null;
    let previousDriverLatLng = null;
    let animationFrameId;
    let iconImage = new Image();

  
    iconImage.src = "public/bike.png";

    const expiredNotice = document.getElementById('expiredNotice');
    const mapDiv = document.getElementById('map');
    const errorMsg = document.getElementById('errorMsg');

    function initMap(center) {
      map = new google.maps.Map(mapDiv, {
        zoom: 15,
        center,
      });
      mapDiv.style.display = 'block';
    }

    function toLatLng(point) {
      if (!point) return null;
      if (Array.isArray(point)) return { lat: point[0], lng: point[1] };
      if (point.latitude !== undefined && point.longitude !== undefined)
        return { lat: point.latitude, lng: point.longitude };
      return null;
    }

    function clearAll() {
      if (driverMarker) driverMarker.setMap(null);
      if (dropoffMarker) dropoffMarker.setMap(null);
      if (routePolyline) routePolyline.setMap(null);
      if (driverInfoWindow) driverInfoWindow.close();
      if (dropoffInfoWindow) dropoffInfoWindow.close();
      driverMarker = dropoffMarker = routePolyline = null;
      driverInfoWindow = dropoffInfoWindow = null;
      previousDriverLatLng = null;
      if (animationFrameId) cancelAnimationFrame(animationFrameId);
    }

    function removeInfoWindowCloseButton() {
      setTimeout(() => {
        const iwOuter = document.querySelector('.gm-style-iw');
        const closeBtn = iwOuter?.parentNode?.querySelector('button[title="Close"]');
        if (closeBtn) closeBtn.style.display = 'none';
      }, 100);
    }

    function drawRouteWithDirectionsAPI(origin, destination) {
      const directionsService = new google.maps.DirectionsService();

      directionsService.route({
        origin,
        destination,
        travelMode: google.maps.TravelMode.DRIVING,
      }, (result, status) => {
        if (status === google.maps.DirectionsStatus.OK) {
          const path = result.routes[0].overview_path;

          if (!routePolyline) {
            routePolyline = new google.maps.Polyline({
              path,
              geodesic: true,
              strokeColor: "#000000",
              strokeOpacity: 0.9,
              strokeWeight: 5,
              map: map,
            });
          } else {
            routePolyline.setPath(path);
          }
        } else {
          console.error("Directions request failed:", status);
          if(routePolyline) {
            routePolyline.setMap(null);
            routePolyline = null;
          }
        }
      });
    }

    function calculateBearing(startLatLng, endLatLng) {
      const toRad = deg => deg * Math.PI / 180;
      const toDeg = rad => rad * 180 / Math.PI;

      const lat1 = toRad(startLatLng.lat);
      const lon1 = toRad(startLatLng.lng);
      const lat2 = toRad(endLatLng.lat);
      const lon2 = toRad(endLatLng.lng);

      const dLon = lon2 - lon1;
      const y = Math.sin(dLon) * Math.cos(lat2);
      const x = Math.cos(lat1) * Math.sin(lat2) -
                Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);
      const bearing = toDeg(Math.atan2(y, x));
      return (bearing + 360) % 360;
    }
function getRotatedIcon(angle) {
  if (!iconImage.complete || iconImage.naturalWidth === 0) {
    return "https://maps.google.com/mapfiles/ms/icons/red-dot.png";
  }

  const canvas = document.createElement("canvas");
  canvas.width = 150; 
  canvas.height = 150;
  const ctx = canvas.getContext("2d");

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.translate(canvas.width / 2, canvas.height / 2);
  ctx.rotate(angle * Math.PI / 180);
  ctx.drawImage(iconImage, -75, -75, 150, 150); 
  return {
    url: canvas.toDataURL(),
    scaledSize: new google.maps.Size(120, 120),
    anchor: new google.maps.Point(60, 60),
  };
}


    function animateDriverMarker(startLatLng, endLatLng) {
      if (!startLatLng || !endLatLng || !driverMarker) return;

      const deltaLat = endLatLng.lat - startLatLng.lat;
      const deltaLng = endLatLng.lng - startLatLng.lng;
      const steps = 60;
      let step = 0;

      const bearing = calculateBearing(startLatLng, endLatLng);
      driverMarker.setIcon(getRotatedIcon(bearing));

      function move() {
        step++;
        const progress = step / steps;
        const intermediateLat = startLatLng.lat + deltaLat * progress;
        const intermediateLng = startLatLng.lng + deltaLng * progress;
        const intermediatePosition = new google.maps.LatLng(intermediateLat, intermediateLng);

        driverMarker.setPosition(intermediatePosition);
        map.setCenter(intermediatePosition);

        if (step < steps) {
          animationFrameId = requestAnimationFrame(move);
        }
      }

      if (animationFrameId) cancelAnimationFrame(animationFrameId);
      animationFrameId = requestAnimationFrame(move);
    }

    function trackOrder(orderId) {
      if (unsubscribe) unsubscribe();
      clearAll();
      expiredNotice.style.display = 'none';
      errorMsg.style.display = 'none';

      const orderRef = db.collection("orders").doc(orderId);

      unsubscribe = orderRef.onSnapshot(doc => {
        if (!doc.exists) {
          errorMsg.textContent = "Order not found.";
          errorMsg.style.display = 'block';
          return;
        }

        const data = doc.data();

        if (["cancelled", "order_delivered","resolved","unresolved"].includes(data.status)) {
          expiredNotice.style.display = "block";
          clearAll();
          return;
        }

        const driverLatLng = toLatLng(data.driverLocation);
        const dropLatLng = toLatLng(data.location);

        if (!map && (driverLatLng || dropLatLng)) {
          initMap(driverLatLng || dropLatLng);
        }

        if (driverLatLng) {
          if (!driverMarker) {
            driverMarker = new google.maps.Marker({
              position: driverLatLng,
              map,
              icon: getRotatedIcon(0), 
            });
            driverInfoWindow = new google.maps.InfoWindow({
              content: `<div style="font-weight:bold;font-size:13px;padding:4px;background:#d4edda;border:1px solid #c3e6cb;border-radius:4px;color:#155724;">Driver${data.driverName ? ": " + data.driverName : ""}</div>`,
              disableAutoPan: true,
              pixelOffset: new google.maps.Size(0, -30),
              maxWidth: 180,
            });
            driverInfoWindow.open(map, driverMarker);
            removeInfoWindowCloseButton();

            previousDriverLatLng = driverLatLng;
          } else {

            if (previousDriverLatLng &&
                (previousDriverLatLng.lat !== driverLatLng.lat ||
                 previousDriverLatLng.lng !== driverLatLng.lng)) {
              animateDriverMarker(previousDriverLatLng, driverLatLng);
            } else {
              driverMarker.setPosition(driverLatLng);
              map.setCenter(driverLatLng);
            }
            driverInfoWindow.setContent(`<div style="font-weight:bold;font-size:13px;padding:4px;background:#d4edda;border:1px solid #c3e6cb;border-radius:4px;color:#155724;">Driver${data.driverName ? ": " + data.driverName : ""}</div>`);
            driverInfoWindow.open(map, driverMarker);

            previousDriverLatLng = driverLatLng;
          }
        }

        if (dropLatLng) {
          if (!dropoffMarker) {
            dropoffMarker = new google.maps.Marker({
              position: dropLatLng,
              map,
              icon: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png",
            });
            dropoffInfoWindow = new google.maps.InfoWindow({
              content: `<div style="font-weight:bold;font-size:13px;padding:4px;background:#cce5ff;border:1px solid #b8daff;border-radius:4px;color:#004085;">Drop-off</div>`,
              disableAutoPan: true,
              pixelOffset: new google.maps.Size(0, -30),
              maxWidth: 180,
            });
            dropoffInfoWindow.open(map, dropoffMarker);
            removeInfoWindowCloseButton();
          } else {
            dropoffMarker.setPosition(dropLatLng);
          }
        }

        if (driverLatLng && dropLatLng) {
          drawRouteWithDirectionsAPI(driverLatLng, dropLatLng);
        } else if (routePolyline) {
          routePolyline.setMap(null);
          routePolyline = null;
        }

      }, err => {
        errorMsg.textContent = "Failed to load tracking data.";
        errorMsg.style.display = 'block';
        console.error(err);
      });
    }

    const urlParams = new URLSearchParams(window.location.search);
    const orderId = urlParams.get("orderId");
    if (orderId) {
      trackOrder(orderId);
    } else {
      errorMsg.textContent = "Missing order ID in URL.";
      errorMsg.style.display = 'block';
    }
  </script>
</body>
</html>
